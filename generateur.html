<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planificateur d'activités avec timeline</title>
<style>
  body {
    font-family: 'Segoe UI', Roboto, sans-serif;
    margin: 0;
    padding: 2rem;
    background: rgb(239,231,220);
    color: #1e1e2f;
    line-height: 1.6;
  }

  h1 {
    text-align: center;
    color: #b30808;
    font-size: 2.2rem;
    margin-bottom: 2rem;
  }

  form {
    max-width: 760px;
    margin: auto;
    padding: 2rem;
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 8px 8px 16px rgba(0,0,0,0.05), -8px -8px 16px rgba(255,255,255,0.8);
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    justify-content: space-between;
  }

  label {
    display: flex;
    flex-direction: column;
    font-weight: 600;
    color: #333;
    flex: 1 1 200px;
  }

  select, input[type=number] {
    margin-top: 0.5rem;
    padding: 0.6rem 0.8rem;
    font-size: 1rem;
    border: none;
    border-radius: 10px;
    background: #f0f4f8;
    box-shadow: inset 2px 2px 6px rgba(0,0,0,0.05), inset -2px -2px 6px rgba(255,255,255,0.6);
    transition: all 0.2s ease-in-out;
  }

  select:focus, input[type=number]:focus {
    outline: none;
    background: #e4ecf4;
  }

  button {
    padding: 0.7rem 1.6rem;
    font-weight: bold;
    font-size: 1rem;
    background: linear-gradient(to right, #0078d4, #005a9e);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.2s ease, background 0.3s ease;
  }

  button:hover {
    transform: translateY(-2px);
    background: linear-gradient(to right, #005a9e, #004f8c);
  }

  #timeline-container {
    margin: 3rem auto;
    max-width: 950px;
    background: #ffffff;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 8px 8px 16px rgba(0,0,0,0.05), -8px -8px 16px rgba(255,255,255,0.8);
    overflow-x: auto;
  }

  #timeline {
    position: relative;
    height: 100px;
    border-top: 4px solid #b30808;
    border-bottom: 4px solid #b30808;
    display: flex;
    gap: 1px;
  }

  .hour-block {
    flex: 1;
    text-align: center;
    font-weight: 600;
    font-size: 0.9rem;
    color: #444;
    border-left: 1px solid #ccc;
    position: relative;
    padding-top: 0.5rem;
  }

  .hour-block:first-child {
    border-left: none;
  }

  .activity {
    position: absolute;
    top: 12px;
    background: #0078d4;
    color: white;
    padding: 6px 12px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.85rem;
    white-space: nowrap;
    box-shadow: 0 6px 12px rgba(0, 120, 212, 0.4);
    transition: transform 0.2s ease;
  }

  .activity:hover {
    transform: scale(1.05);
  }

  .activity.mealIncluded {
    background: #28a745;
  }

  #resultats {
    max-width: 760px;
    margin: 2rem auto;
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 8px 8px 16px rgba(0,0,0,0.05), -8px -8px 16px rgba(255,255,255,0.8);
  }
</style>
</head>
<body>

<h1>Planificateur d'activités avec timeline</h1>

<form id="formFiltres">
  <label>
    Date de la journée :
    <input type="date" id="inputDate" required />
  </label>

  <label>
    Ambiance secondaire :
    <select id="selectAmbiance">
      <option value="">-- Toutes --</option>
      <option value="sportif">Sportif</option>
      <option value="gastronomique">Gastronomique</option>
      <option value="chill">Chill</option>
      <option value="romantique">Romantique</option>
      <option value="insolite">Insolite</option>
    </select>
  </label>

  <label>
    Repas inclus obligatoire ?
    <select id="selectRepas">
      <option value="non">Non</option>
      <option value="oui">Oui</option>
    </select>
  </label>

  <label>
    Budget max total (€) :
    <input type="number" id="inputBudget" value="100" min="0" />
  </label>

  <label>
    Heure début (24h) :
    <input type="number" id="inputHeureDebut" value="8" min="0" max="23" />
  </label>

  <label>
    Heure fin (24h) :
    <input type="number" id="inputHeureFin" value="20" min="1" max="24" />
  </label>

  <button type="submit">Planifier</button>
</form>
<section id="experience-osmoz" style="margin-bottom:20px; font-weight:bold; font-size:1.2em;">
  Votre expérience Osmoz du <span id="date-experience"></span>
</section>
<div id="timeline-container" style="position:relative; width: 900px; border: 1px solid #ccc; height: 100px; margin-top: 20px;">
  <div id="timeline" style="position:relative; height: 100%;"></div>
</div>

<div id="resultats"></div>

<script>
  // Activités (inchangé)
  const activites = [
    {
      id: "rando_esterel",
      title: "Randonnée Estérel avec vue mer",
      phone: "",
      reservationLink: "https://visorando.com/randonnee-esterel",
      address: "Massif de l'Estérel, 83400 Fréjus",
      description: "Explorez les roches rouges de l'Estérel et profitez d'un panorama à couper le souffle sur la Méditerranée.",
      mealIncluded: false,
      duration: 3,
      primaryCategory: "matin",
      secondaryCategory: "sportif",
      budget: 0
    },
    {
      id: "marche_castel",
      title: "Marché du Château et street food niçoise",
      phone: "",
      reservationLink: "https://goo.gl/maps/castel-food",
      address: "Place du Château, 06300 Nice",
      description: "Parcourez les étals colorés du marché et dégustez socca, pissaladière et autres spécialités locales.",
      mealIncluded: true,
      duration: 1,
      primaryCategory: "midi",
      secondaryCategory: "gastronomique",
      budget: 20
    },
    {
      id: "musee_chagall",
      title: "Musée Marc Chagall",
      phone: "+33 4 97 18 53 77",
      reservationLink: "https://musees-nice.org/chagall",
      address: "Avenue Dr Ménard, 06000 Nice",
      description: "Plongez dans l’œuvre biblique et colorée de Chagall, chef‑de‑file de l’art moderne.",
      mealIncluded: false,
      duration: 1.5,
      primaryCategory: "matin",
      secondaryCategory: "chill",
      budget: 12
    },
    {
      id: "cours_cuisine_niçoise",
      title: "Cours de cuisine niçoise",
      phone: "+33 4 93 16 82 40",
      reservationLink: "https://www.latelierpastry.com",
      address: "4 Rue Barillerie, 06300 Nice",
      description: "Apprenez à préparer socca, pissaladière et tourte de blettes avec un chef local.",
      mealIncluded: true,
      duration: 2,
      primaryCategory: "midi",
      secondaryCategory: "gastronomique",
      budget: 35
    },
    {
      id: "canoe_parc_naturel_mercantour",
      title: "Canoë dans le Parc du Mercantour",
      phone: "+33 6 07 03 09 39",
      reservationLink: "https://funbooker.com/canoe-mercantour",
      address: "Lac de Saint-Cassien, 83540 Mons",
      description: "Descendez les eaux turquoise du lac et ses criques sauvages en canoë.",
      mealIncluded: false,
      duration: 3,
      primaryCategory: "après-midi",
      secondaryCategory: "sportif",
      budget: 25
    },
    {
      id: "croisiere_soleil",
      title: "Croisière au coucher du soleil",
      phone: "+33 4 93 85 18 82",
      reservationLink: "https://getyourguide.com/solar-boat-nice",
      address: "Port Lympia, Quai Papacino, 06300 Nice",
      description: "Naviguez à bord d’un bateau solaire et admirez le coucher de soleil sur la Baie des Anges.",
      mealIncluded: false,
      duration: 2,
      primaryCategory: "soir",
      secondaryCategory: "romantique",
      budget: 40
    },
    {
      id: "spectacle_soir",
      title: "Spectacle au théâtre",
      phone: "+33 4 93 82 50 50",
      reservationLink: "https://theatrenice.fr",
      address: "2 Avenue Saint-Jean-Baptiste, 06000 Nice",
      description: "Profitez d’une soirée culturelle avec un spectacle de théâtre local.",
      mealIncluded: false,
      duration: 2,
      primaryCategory: "soir",
      secondaryCategory: "chill",
      budget: 25
    }
  ];

  const form = document.getElementById('formFiltres');
  const timeline = document.getElementById('timeline');
  const resultats = document.getElementById('resultats');

  // Timeline hours setup (unchanged)
  function creerTimeline(heureDebut, heureFin) {
    timeline.innerHTML = "";
    const heuresCount = heureFin - heureDebut;
    for (let i = 0; i < heuresCount; i++) {
      const heureBloc = document.createElement('div');
      heureBloc.className = 'hour-block';
      heureBloc.style.flex = '1';
      heureBloc.style.position = 'absolute';
      heureBloc.style.left = `${(i * (900 / heuresCount))}px`;
      heureBloc.style.top = '80px';
      heureBloc.style.width = `${900 / heuresCount}px`;
      heureBloc.style.textAlign = 'center';
      heureBloc.style.fontSize = '10px';
      heureBloc.textContent = `${(heureDebut + i).toString().padStart(2, '0')}h`;
      timeline.appendChild(heureBloc);
    }
  }

  const categorieHorairePlages = {
    matin: { debut: 8, fin: 12 },
    midi: { debut: 12, fin: 14 },
    "après-midi": { debut: 14, fin: 18 },
    soir: { debut: 18, fin: 22 }
  };

  // Fonction filtre (inchangée)
  function filtrerActivites(ambiance, repasObligatoire, budgetMax) {
    return activites.filter(act => {
      if (ambiance && act.secondaryCategory !== ambiance) return false;
      if (repasObligatoire === "oui" && !act.mealIncluded) return false;
      if (act.budget > budgetMax) return false;
      return true;
    });
  }

  // Variables globales pour drag & resize
  let dragData = null; // { element, startX, origLeft, timelineLeft, pxParHeure }
  let resizeData = null; // { element, startX, origWidth, timelineLeft, pxParHeure }

  // Fonction pour rendre les activités drag & resize
  function rendreDragResize(element, pxParHeure, heureDebutGlobal, heureFinGlobal) {
    element.style.position = 'absolute';
    element.style.top = '20px';
    element.style.cursor = 'move';
    element.style.userSelect = 'none';

    // Ajouter poignée de resize à droite
    const resizeHandle = document.createElement('div');
    resizeHandle.style.position = 'absolute';
    resizeHandle.style.right = '0';
    resizeHandle.style.top = '0';
    resizeHandle.style.width = '6px';
    resizeHandle.style.height = '100%';
    resizeHandle.style.cursor = 'ew-resize';
    resizeHandle.style.background = 'rgba(0,0,0,0.1)';
    element.appendChild(resizeHandle);

    // Drag start
    element.addEventListener('mousedown', e => {
      if (e.target === resizeHandle) return; // resize handled separately
      e.preventDefault();
      dragData = {
        element: element,
        startX: e.clientX,
        origLeft: parseFloat(element.style.left),
        timelineLeft: timeline.getBoundingClientRect().left,
        pxParHeure: pxParHeure,
        heureDebutGlobal,
        heureFinGlobal
      };
      window.addEventListener('mousemove', dragMove);
      window.addEventListener('mouseup', dragEnd);
    });

    // Resize start
    resizeHandle.addEventListener('mousedown', e => {
      e.preventDefault();
      e.stopPropagation();
      resizeData = {
        element: element,
        startX: e.clientX,
        origWidth: parseFloat(element.style.width),
        timelineLeft: timeline.getBoundingClientRect().left,
        pxParHeure: pxParHeure,
        heureDebutGlobal,
        heureFinGlobal
      };
      window.addEventListener('mousemove', resizeMove);
      window.addEventListener('mouseup', resizeEnd);
    });
  }

  // Drag move
  function dragMove(e) {
    if (!dragData) return;
    e.preventDefault();

    let deltaX = e.clientX - dragData.startX;
    let newLeft = dragData.origLeft + deltaX;

    // Clamp dans timeline
    if (newLeft < 0) newLeft = 0;
    const maxLeft = (dragData.heureFinGlobal - dragData.heureDebutGlobal) * dragData.pxParHeure - dragData.element.offsetWidth;
    if (newLeft > maxLeft) newLeft = maxLeft;

    dragData.element.style.left = newLeft + 'px';
  }

  function dragEnd(e) {
    if (!dragData) return;
    e.preventDefault();
    window.removeEventListener('mousemove', dragMove);
    window.removeEventListener('mouseup', dragEnd);
    dragData = null;
  }

  // Resize move
  function resizeMove(e) {
    if (!resizeData) return;
    e.preventDefault();

    let deltaX = e.clientX - resizeData.startX;
    let newWidth = resizeData.origWidth + deltaX;

    // Minimum width: 0.25h (px)
    const minWidth = resizeData.pxParHeure * 0.25;
    if (newWidth < minWidth) newWidth = minWidth;

    // Max width = jusqu'à la fin timeline
    const maxWidth = (resizeData.heureFinGlobal - resizeData.heureDebutGlobal) * resizeData.pxParHeure - parseFloat(resizeData.element.style.left);
    if (newWidth > maxWidth) newWidth = maxWidth;

    resizeData.element.style.width = newWidth + 'px';
  }

  function resizeEnd(e) {
    if (!resizeData) return;
    e.preventDefault();
    window.removeEventListener('mousemove', resizeMove);
    window.removeEventListener('mouseup', resizeEnd);
    resizeData = null;
  }

  // Afficher activités dans timeline avec drag & resize
  function afficherActivitesSurTimeline(activitesFiltrees, heureDebutGlobal, heureFinGlobal) {
    creerTimeline(heureDebutGlobal, heureFinGlobal);

    const timelineWidth = timeline.clientWidth || 900;
    const totalHeures = heureFinGlobal - heureDebutGlobal;
    const pxParHeure = timelineWidth / totalHeures;

    // Supprimer anciennes activités
    timeline.querySelectorAll('.activity').forEach(el => el.remove());

    // Créer activités
    activitesFiltrees.forEach(act => {
      const plage = categorieHorairePlages[act.primaryCategory];
      if (!plage) return;

      let debut = Math.max(plage.debut, heureDebutGlobal);
      let fin = Math.min(plage.fin, heureFinGlobal);

      let duree = act.duration;
      if (debut + duree > fin) {
        duree = fin - debut;
      }
      if (duree <= 0) return;

      const leftPx = (debut - heureDebutGlobal) * pxParHeure;
      const widthPx = duree * pxParHeure - 4;

      const actDiv = document.createElement('div');
      actDiv.className = 'activity' + (act.mealIncluded ? ' mealIncluded' : '');
      actDiv.style.position = 'absolute';
      actDiv.style.top = '20px';
      actDiv.style.left = `${leftPx}px`;
      actDiv.style.width = `${widthPx}px`;
      actDiv.style.height = '40px';
      actDiv.style.background = '#90caf9';
      actDiv.style.border = '1px solid #42a5f5';
      actDiv.style.borderRadius = '4px';
      actDiv.style.padding = '2px 6px';
      actDiv.style.boxSizing = 'border-box';
      actDiv.style.cursor = 'move';
      actDiv.style.userSelect = 'none';
      actDiv.title = `${act.title}\n${act.description}\nBudget: €${act.budget}\nDurée: ${act.duration}h`;
      actDiv.textContent = act.title;

      timeline.appendChild(actDiv);

      rendreDragResize(actDiv, pxParHeure, heureDebutGlobal, heureFinGlobal);
    });
  }

  // Validation date : pas dans le passé
  function validerDatePasPassee(inputDate) {
    if (!inputDate) return false;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const dateChoisie = new Date(inputDate);
    dateChoisie.setHours(0, 0, 0, 0);
    return dateChoisie >= today;
  }

  form.addEventListener('submit', e => {
    e.preventDefault();

    const dateJour = document.getElementById('inputDate').value;
    if (!validerDatePasPassee(dateJour)) {
      alert("La date choisie ne peut pas être dans le passé.");
      return;
    }

    const ambiance = document.getElementById('selectAmbiance').value;
    const repasObligatoire = document.getElementById('selectRepas').value;
    const budgetMax = Number(document.getElementById('inputBudget').value);
    const heureDebutGlobal = Number(document.getElementById('inputHeureDebut').value);
    const heureFinGlobal = Number(document.getElementById('inputHeureFin').value);

    if (heureDebutGlobal >= heureFinGlobal) {
      alert("L'heure de début doit être inférieure à l'heure de fin.");
      return;
    }

    const actsFiltres = filtrerActivites(ambiance, repasObligatoire, budgetMax);

    // Vérifier que le budget total ne dépasse pas le budget max
    const totalBudget = actsFiltres.reduce((sum, a) => sum + a.budget, 0);
    if (totalBudget > budgetMax) {
      alert(`Le budget total des activités (${totalBudget}€) dépasse le budget max demandé (${budgetMax}€).`);
      return;
    }

    afficherActivitesSurTimeline(actsFiltres, heureDebutGlobal, heureFinGlobal);

    resultats.innerHTML = `
      <h2>Activités filtrées (${actsFiltres.length})</h2>
      <ul>
        ${actsFiltres.map(a => `<li><strong>${a.title}</strong> — Budget: €${a.budget}, Durée: ${a.duration}h, Repas inclus: ${a.mealIncluded ? "Oui" : "Non"}</li>`).join('')}
      </ul>
      <p><strong>Budget total estimé : €${totalBudget}</strong></p>
    `;
  });

  // Initialisation date par défaut à aujourd'hui
  const inputDate = document.getElementById('inputDate');
  const todayISO = new Date().toISOString().split('T')[0];
  inputDate.value = todayISO;

  creerTimeline(8, 20);
   const dateSpan = document.getElementById('date-experience');
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  const today = new Date();
  dateSpan.textContent = today.toLocaleDateString('fr-FR', options);
</script>

</body>
</html>
